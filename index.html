<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced 3D Celestial Simulation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
            color: white;
            user-select: none;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            perspective: 1000px;
        }

        #scene {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        #sky {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: all 3s cubic-bezier(0.4, 0, 0.2, 1);
            background: radial-gradient(ellipse at center, #001122 0%, #000011 100%);
        }

        .celestial-body {
            position: absolute;
            border-radius: 50%;
            transition: all 2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        #sun {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle at 30% 30%, #fff700, #ffeb3b, #ff9800, #ff5722);
            box-shadow: 
                0 0 100px rgba(255, 235, 59, 0.8),
                0 0 200px rgba(255, 152, 0, 0.6),
                0 0 300px rgba(255, 87, 34, 0.4),
                inset -20px -20px 40px rgba(255, 87, 34, 0.3);
            animation: sunPulse 4s ease-in-out infinite alternate;
            filter: brightness(1.2) saturate(1.3);
        }

        #sun::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(circle, rgba(255, 235, 59, 0.3), transparent 70%);
            border-radius: 50%;
            animation: coronaRotate 20s linear infinite;
        }

        #moon {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 35% 25%, #f8f8f8, #e0e0e0, #bdbdbd, #9e9e9e);
            box-shadow: 
                0 0 60px rgba(248, 248, 248, 0.4),
                inset -15px -15px 30px rgba(0, 0, 0, 0.3),
                inset 10px 10px 20px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .crater {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.6);
        }

        .crater1 { width: 12px; height: 12px; top: 25px; left: 30px; }
        .crater2 { width: 18px; height: 18px; top: 40px; right: 25px; }
        .crater3 { width: 8px; height: 8px; bottom: 30px; left: 35px; }
        .crater4 { width: 14px; height: 14px; top: 20px; right: 40px; }
        .crater5 { width: 10px; height: 10px; bottom: 40px; right: 30px; }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 200px 60px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 250px 20px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 300px 90px, rgba(255,255,255,0.9), transparent);
            background-repeat: repeat;
            background-size: 350px 120px;
            animation: twinkle 6s ease-in-out infinite alternate;
            opacity: 0;
        }

        .milky-way {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255,255,255,0.1) 40%, 
                rgba(255,255,255,0.05) 60%, 
                transparent 70%);
            opacity: 0;
            transition: opacity 2s ease;
        }

        .clouds {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 40"><ellipse cx="40" cy="20" rx="25" ry="12" fill="rgba(255,255,255,0.3)"/><ellipse cx="60" cy="20" rx="30" ry="15" fill="rgba(255,255,255,0.2)"/><ellipse cx="80" cy="20" rx="20" ry="10" fill="rgba(255,255,255,0.25)"/><ellipse cx="120" cy="20" rx="35" ry="18" fill="rgba(255,255,255,0.2)"/><ellipse cx="160" cy="20" rx="25" ry="12" fill="rgba(255,255,255,0.3)"/></svg>');
            background-size: 400px 80px;
            animation: cloudDrift 30s linear infinite;
            opacity: 0.6;
        }

        .atmosphere {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center bottom, 
                rgba(135, 206, 235, 0.3) 0%, 
                rgba(135, 206, 235, 0.1) 30%, 
                transparent 60%);
            opacity: 0;
            transition: opacity 2s ease;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 350px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        #info-panel:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-2px);
        }

        .info-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .info-header i {
            margin-right: 10px;
            color: #64b5f6;
        }

        .info-item {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #b0bec5;
        }

        .info-value {
            font-weight: 600;
            color: #ffffff;
        }

        .phase-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .phase-visual {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #424242;
            position: relative;
            overflow: hidden;
            border: 1px solid #666;
        }

        .phase-light {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-radius: 50%;
            transition: all 0.5s ease;
        }

        .weather-info {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .weather-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .control-btn.active {
            background: rgba(100, 181, 246, 0.3);
            border-color: #64b5f6;
        }

        .time-controls {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 400px;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #b0bec5;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .speed-indicator {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #64b5f6;
            font-weight: 600;
        }

        .horizon {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 250px;
            background: linear-gradient(to top, 
                rgba(76, 175, 80, 0.3) 0%,
                rgba(76, 175, 80, 0.2) 30%,
                rgba(76, 175, 80, 0.1) 60%,
                transparent 100%);
            transition: all 2s ease;
        }

        .location-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .location-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .location-header i {
            margin-right: 8px;
            color: #4caf50;
        }

        @keyframes sunPulse {
            0% { 
                box-shadow: 
                    0 0 100px rgba(255, 235, 59, 0.8),
                    0 0 200px rgba(255, 152, 0, 0.6),
                    0 0 300px rgba(255, 87, 34, 0.4);
                filter: brightness(1.2) saturate(1.3);
            }
            100% { 
                box-shadow: 
                    0 0 150px rgba(255, 235, 59, 1),
                    0 0 250px rgba(255, 152, 0, 0.8),
                    0 0 350px rgba(255, 87, 34, 0.6);
                filter: brightness(1.4) saturate(1.5);
            }
        }

        @keyframes coronaRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes twinkle {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.5; }
        }

        @keyframes cloudDrift {
            0% { transform: translateX(-200px); }
            100% { transform: translateX(calc(100vw + 200px)); }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            #info-panel, .location-panel {
                position: relative;
                margin: 10px;
                min-width: auto;
                width: calc(100% - 20px);
            }
            
            .time-controls {
                min-width: 300px;
                margin: 0 10px;
            }
            
            #controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Celestial Simulation...</div>
    </div>

    <div id="container">
        <div id="scene">
            <div id="sky">
                <div class="stars"></div>
                <div class="milky-way"></div>
                <div class="clouds"></div>
                <div class="atmosphere"></div>
                <div class="horizon"></div>
            </div>
            
            <div id="sun" class="celestial-body"></div>
            
            <div id="moon" class="celestial-body">
                <div class="crater crater1"></div>
                <div class="crater crater2"></div>
                <div class="crater crater3"></div>
                <div class="crater crater4"></div>
                <div class="crater crater5"></div>
            </div>
        </div>

        <div id="info-panel" class="animate__animated animate__fadeInLeft">
            <div class="info-header">
                <i class="fas fa-satellite"></i>
                Celestial Data
            </div>
            <div class="info-item">
                <span class="info-label"><i class="far fa-clock"></i> Local Time:</span>
                <span class="info-value" id="local-time"></span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-sun"></i> Sun Position:</span>
                <span class="info-value" id="sun-position"></span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-moon"></i> Moon Position:</span>
                <span class="info-value" id="moon-position"></span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-circle"></i> Moon Phase:</span>
                <div class="phase-indicator">
                    <div class="phase-visual">
                        <div class="phase-light" id="phase-light"></div>
                    </div>
                    <span class="info-value" id="moon-phase-name"></span>
                </div>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-sunrise"></i> Sunrise:</span>
                <span class="info-value" id="sunrise-time"></span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-sunset"></i> Sunset:</span>
                <span class="info-value" id="sunset-time"></span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-eye"></i> Visibility:</span>
                <span class="info-value" id="visibility"></span>
            </div>
            
            <div class="weather-info" id="weather-info">
                <div class="info-header" style="margin-bottom: 10px; font-size: 14px;">
                    <i class="fas fa-cloud-sun"></i>
                    Weather Conditions
                </div>
                <div class="weather-item">
                    <span>Temperature:</span>
                    <span id="temperature">--°C</span>
                </div>
                <div class="weather-item">
                    <span>Humidity:</span>
                    <span id="humidity">--%</span>
                </div>
                <div class="weather-item">
                    <span>Cloud Cover:</span>
                    <span id="cloud-cover">--%</span>
                </div>
                <div class="weather-item">
                    <span>Wind Speed:</span>
                    <span id="wind-speed">-- km/h</span>
                </div>
            </div>
        </div>

        <div class="location-panel animate__animated animate__fadeInRight">
            <div class="location-header">
                <i class="fas fa-map-marker-alt"></i>
                Location & Coordinates
            </div>
            <div class="info-item">
                <span class="info-label">City:</span>
                <span class="info-value" id="location-name">Detecting...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Latitude:</span>
                <span class="info-value" id="latitude">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Longitude:</span>
                <span class="info-value" id="longitude">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Timezone:</span>
                <span class="info-value" id="timezone">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Elevation:</span>
                <span class="info-value" id="elevation">-- m</span>
            </div>
        </div>

        <div class="time-controls animate__animated animate__fadeInUp">
            <div class="slider-container">
                <div class="slider-label">
                    <span><i class="far fa-clock"></i> Time Control</span>
                    <span id="slider-time"></span>
                </div>
                <input type="range" id="timeSlider" min="0" max="1440" value="0" step="1">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span><i class="fas fa-calendar-alt"></i> Date Control</span>
                    <span id="date-display"></span>
                </div>
                <input type="range" id="dateSlider" min="-365" max="365" value="0" step="1">
            </div>
            <div class="speed-indicator">
                Speed: <span id="speed-display">1x</span>
            </div>
        </div>

        <div id="controls" class="animate__animated animate__fadeInUp">
            <button class="control-btn" onclick="toggleRealTime()" id="realTimeBtn">
                <i class="fas fa-play"></i> Real Time
            </button>
            <button class="control-btn" onclick="speedUp()">
                <i class="fas fa-fast-forward"></i> Speed Up
            </button>
            <button class="control-btn" onclick="slowDown()">
                <i class="fas fa-backward"></i> Slow Down
            </button>
            <button class="control-btn" onclick="resetSimulation()">
                <i class="fas fa-redo"></i> Reset
            </button>
            <button class="control-btn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i> Fullscreen
            </button>
            <button class="control-btn" onclick="captureScreenshot()">
                <i class="fas fa-camera"></i> Screenshot
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script>
        class AdvancedCelestialSimulation {
            constructor() {
                this.isRealTime = true;
                this.speedMultiplier = 1;
                this.currentTime = new Date();
                this.baseDate = new Date();
                this.latitude = 40.7128;
                this.longitude = -74.0060;
                this.timezone = 'America/New_York';
                this.elevation = 0;
                this.animationId = null;
                this.weatherData = null;
                
                this.elements = {
                    sun: document.getElementById('sun'),
                    moon: document.getElementById('moon'),
                    sky: document.getElementById('sky'),
                    stars: document.querySelector('.stars'),
                    milkyWay: document.querySelector('.milky-way'),
                    atmosphere: document.querySelector('.atmosphere'),
                    horizon: document.querySelector('.horizon'),
                    localTime: document.getElementById('local-time'),
                    sunPosition: document.getElementById('sun-position'),
                    moonPosition: document.getElementById('moon-position'),
                    moonPhaseName: document.getElementById('moon-phase-name'),
                    phaseLight: document.getElementById('phase-light'),
                    sunriseTime: document.getElementById('sunrise-time'),
                    sunsetTime: document.getElementById('sunset-time'),
                    visibility: document.getElementById('visibility'),
                    locationName: document.getElementById('location-name'),
                    latitude: document.getElementById('latitude'),
                    longitude: document.getElementById('longitude'),
                    timezone: document.getElementById('timezone'),
                    elevation: document.getElementById('elevation'),
                    timeSlider: document.getElementById('timeSlider'),
                    dateSlider: document.getElementById('dateSlider'),
                    sliderTime: document.getElementById('slider-time'),
                    dateDisplay: document.getElementById('date-display'),
                    speedDisplay: document.getElementById('speed-display'),
                    realTimeBtn: document.getElementById('realTimeBtn'),
                    loadingScreen: document.getElementById('loadingScreen'),
                    temperature: document.getElementById('temperature'),
                    humidity: document.getElementById('humidity'),
                    cloudCover: document.getElementById('cloud-cover'),
                    windSpeed: document.getElementById('wind-speed')
                };

                this.init();
            }

            async init() {
                try {
                    await this.getUserLocation();
                    await this.getWeatherData();
                    this.setupEventListeners();
                    this.hideLoadingScreen();
                    this.startSimulation();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.hideLoadingScreen();
                    this.startSimulation();
                }
            }

            hideLoadingScreen() {
                setTimeout(() => {
                    this.elements.loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        this.elements.loadingScreen.style.display = 'none';
                    }, 500);
                }, 2000);
            }

            async getUserLocation() {
                try {
                    if (navigator.geolocation) {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 300000
                            });
                        });
                        
                        this.latitude = position.coords.latitude;
                        this.longitude = position.coords.longitude;
                        this.elevation = position.coords.altitude || 0;
                        
                        await this.getLocationDetails();
                    }
                } catch (error) {
                    console.warn('Geolocation failed, using default location (NYC)');
                    this.setDefaultLocation();
                }
            }

            setDefaultLocation() {
                this.elements.locationName.textContent = 'New York, NY (Default)';
                this.elements.latitude.textContent = this.latitude.toFixed(4) + '°';
                this.elements.longitude.textContent = this.longitude.toFixed(4) + '°';
                this.elements.timezone.textContent = this.timezone;
                this.elements.elevation.textContent = this.elevation + ' m';
            }

            async getLocationDetails() {
                try {
                    const response = await fetch(
                        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${this.latitude}&longitude=${this.longitude}&localityLanguage=en`
                    );
                    const data = await response.json();
                    
                    const cityName = data.city || data.locality || 'Unknown';
                    const countryCode = data.countryCode || '';
                    
                    this.elements.locationName.textContent = `${cityName}, ${countryCode}`;
                    this.elements.latitude.textContent = this.latitude.toFixed(4) + '°';
                    this.elements.longitude.textContent = this.longitude.toFixed(4) + '°';
                    
                    this.timezone = data.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                    this.elements.timezone.textContent = this.timezone;
                    this.elements.elevation.textContent = this.elevation + ' m';
                    
                } catch (error) {
                    console.error('Location details fetch failed:', error);
                    this.setDefaultLocation();
                }
            }

            async getWeatherData() {
                try {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${this.latitude}&longitude=${this.longitude}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,cloud_cover,wind_speed_10m&timezone=auto`
                    );
                    this.weatherData = await response.json();
                    this.updateWeatherDisplay();
                } catch (error) {
                    console.error('Weather data fetch failed:', error);
                    this.setDefaultWeather();
                }
            }

            updateWeatherDisplay() {
                if (this.weatherData && this.weatherData.current_weather) {
                    const current = this.weatherData.current_weather;
                    const hourly = this.weatherData.hourly;
                    const currentHour = new Date().getHours();
                    
                    this.elements.temperature.textContent = `${Math.round(current.temperature)}°C`;
                    this.elements.windSpeed.textContent = `${Math.round(current.windspeed)} km/h`;
                    
                    if (hourly) {
                        this.elements.humidity.textContent = `${hourly.relative_humidity_2m[currentHour] || '--'}%`;
                        this.elements.cloudCover.textContent = `${hourly.cloud_cover[currentHour] || '--'}%`;
                    }
                } else {
                    this.setDefaultWeather();
                }
            }

            setDefaultWeather() {
                this.elements.temperature.textContent = '--°C';
                this.elements.humidity.textContent = '--%';
                this.elements.cloudCover.textContent = '--%';
                this.elements.windSpeed.textContent = '-- km/h';
            }

            setupEventListeners() {
                this.elements.timeSlider.addEventListener('input', (e) => {
                    const minutes = parseInt(e.target.value);
                    const baseDate = new Date(this.baseDate);
                    baseDate.setHours(0, 0, 0, 0);
                    this.currentTime = new Date(baseDate.getTime() + minutes * 60000);
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                    this.updateDisplay();
                });

                this.elements.dateSlider.addEventListener('input', (e) => {
                    const days = parseInt(e.target.value);
                    this.baseDate = new Date();
                    this.baseDate.setDate(this.baseDate.getDate() + days);
                    
                    const minutes = parseInt(this.elements.timeSlider.value);
                    this.baseDate.setHours(0, 0, 0, 0);
                    this.currentTime = new Date(this.baseDate.getTime() + minutes * 60000);
                    
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                    this.updateDisplay();
                });

                window.addEventListener('resize', () => this.updatePositions());
                
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            this.toggleRealTime();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            this.speedUp();
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.slowDown();
                            break;
                        case 'r':
                            this.resetSimulation();
                            break;
                        case 'f':
                            this.toggleFullscreen();
                            break;
                    }
                });
            }

            calculateSunPosition(date) {
                const sunPos = SunCalc.getPosition(date, this.latitude, this.longitude);
                const azimuth = sunPos.azimuth;
                const altitude = sunPos.altitude;
                
                const radius = Math.min(window.innerWidth, window.innerHeight) * 0.4;
                const x = Math.sin(azimuth) * radius * Math.cos(altitude);
                const y = -Math.sin(altitude) * radius;
                const z = Math.cos(azimuth) * radius * Math.cos(altitude);
                
                return {
                    x: window.innerWidth / 2 + x,
                    y: window.innerHeight / 2 + y,
                    z: z,
                    altitude: altitude,
                    azimuth: azimuth,
                    elevation: altitude * (180 / Math.PI)
                };
            }

            calculateMoonPosition(date) {
                const moonPos = SunCalc.getMoonPosition(date, this.latitude, this.longitude);
                const azimuth = moonPos.azimuth;
                const altitude = moonPos.altitude;
                
                const radius = Math.min(window.innerWidth, window.innerHeight) * 0.35;
                const x = Math.sin(azimuth) * radius * Math.cos(altitude);
                const y = -Math.sin(altitude) * radius;
                const z = Math.cos(azimuth) * radius * Math.cos(altitude);
                
                return {
                    x: window.innerWidth / 2 + x,
                    y: window.innerHeight / 2 + y,
                    z: z,
                    altitude: altitude,
                    azimuth: azimuth,
                    elevation: altitude * (180 / Math.PI)
                };
            }

            calculateMoonPhase(date) {
                const moonIllumination = SunCalc.getMoonIllumination(date);
                return {
                    fraction: moonIllumination.fraction,
                    phase: moonIllumination.phase,
                    angle: moonIllumination.angle
                };
            }

            updateSkyColor(sunAltitude, moonAltitude, moonPhase) {
                const sunElevation = sunAltitude * (180 / Math.PI);
                const moonElevation = moonAltitude * (180 / Math.PI);
                const moonIllumination = moonPhase.fraction;
                
                let skyColor, starsOpacity = 0, milkyWayOpacity = 0, atmosphereOpacity = 0;
                
                if (sunElevation > 6) {
                    skyColor = 'radial-gradient(ellipse at center, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%)';
                    starsOpacity = 0;
                    atmosphereOpacity = 0.8;
                } else if (sunElevation > -6) {
                    const twilightProgress = (sunElevation + 6) / 12;
                    const r1 = Math.round(135 + (255 - 135) * (1 - twilightProgress));
                    const g1 = Math.round(206 + (165 - 206) * (1 - twilightProgress));
                    const b1 = Math.round(235 + (0 - 235) * (1 - twilightProgress));
                    const r2 = Math.round(152 + (255 - 152) * (1 - twilightProgress));
                    const g2 = Math.round(216 + (107 - 216) * (1 - twilightProgress));
                    const b2 = Math.round(232 + (53 - 232) * (1 - twilightProgress));
                    
                    skyColor = `radial-gradient(ellipse at center, rgb(${r1},${g1},${b1}) 0%, rgb(${r2},${g2},${b2}) 100%)`;
                    starsOpacity = Math.max(0, 1 - twilightProgress);
                    atmosphereOpacity = twilightProgress * 0.6;
                } else if (sunElevation > -18) {
                    const nightProgress = (sunElevation + 18) / 12;
                    skyColor = `radial-gradient(ellipse at center, #001122 0%, #000011 100%)`;
                    starsOpacity = Math.max(0.5, 1 - nightProgress * 0.3);
                    milkyWayOpacity = moonElevation > 0 ? Math.min(0.6, moonIllumination * 0.8) : 0.3;
                    atmosphereOpacity = 0;
                } else {
                    skyColor = 'radial-gradient(ellipse at center, #000011 0%, #000000 100%)';
                    starsOpacity = 1;
                    milkyWayOpacity = moonElevation > 0 ? Math.min(0.8, moonIllumination) : 0.5;
                    atmosphereOpacity = 0;
                }
                
                this.elements.sky.style.background = skyColor;
                this.elements.stars.style.opacity = starsOpacity;
                this.elements.milkyWay.style.opacity = milkyWayOpacity;
                this.elements.atmosphere.style.opacity = atmosphereOpacity;
                
                const horizonColor = sunElevation > -6 ? 
                    `linear-gradient(to top, rgba(76, 175, 80, ${0.3 + (sunElevation + 6) / 12 * 0.4}) 0%, transparent 100%)` :
                    'linear-gradient(to top, rgba(76, 175, 80, 0.2) 0%, transparent 100%)';
                this.elements.horizon.style.background = horizonColor;
            }

            updateMoonPhaseDisplay(moonPhase) {
                const phaseNames = [
                    'New Moon', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous',
                    'Full Moon', 'Waning Gibbous', 'Last Quarter', 'Waning Crescent'
                ];
                
                const phaseIndex = Math.round(moonPhase.phase * 8) % 8;
                const phaseName = phaseNames[phaseIndex];
                
                this.elements.moonPhaseName.textContent = phaseName;
                
                const illumination = moonPhase.fraction;
                const phaseAngle = moonPhase.phase;
                
                if (phaseAngle < 0.5) {
                    this.elements.phaseLight.style.clipPath = `inset(0 ${(1 - illumination * 2) * 50}% 0 0)`;
                } else {
                    this.elements.phaseLight.style.clipPath = `inset(0 0 0 ${(illumination - 0.5) * 2 * 50}%)`;
                }
            }

            calculateVisibility(sunElevation, moonElevation, cloudCover = 0) {
                let visibility = 'Excellent';
                
                if (sunElevation > 0) {
                    visibility = cloudCover > 70 ? 'Poor' : cloudCover > 40 ? 'Fair' : 'Good';
                } else if (sunElevation > -6) {
                    visibility = 'Twilight';
                } else {
                    if (moonElevation > 0) {
                        visibility = cloudCover > 70 ? 'Poor' : cloudCover > 40 ? 'Fair' : 'Excellent';
                    } else {
                        visibility = cloudCover > 50 ? 'Poor' : 'Good';
                    }
                }
                
                return visibility;
            }

            updatePositions() {
                const sunPos = this.calculateSunPosition(this.currentTime);
                const moonPos = this.calculateMoonPosition(this.currentTime);
                const moonPhase = this.calculateMoonPhase(this.currentTime);
                
                const sunVisible = sunPos.elevation > -0.5;
                const moonVisible = moonPos.elevation > -0.5;
                
                this.elements.sun.style.left = `${sunPos.x - 70}px`;
                this.elements.sun.style.top = `${sunPos.y - 70}px`;
                this.elements.sun.style.opacity = sunVisible ? '1' : '0';
                this.elements.sun.style.transform = `translateZ(${sunPos.z}px) scale(${sunVisible ? 1 : 0.8})`;
                
                this.elements.moon.style.left = `${moonPos.x - 50}px`;
                this.elements.moon.style.top = `${moonPos.y - 50}px`;
                this.elements.moon.style.opacity = moonVisible ? '1' : '0.2';
                this.elements.moon.style.transform = `translateZ(${moonPos.z}px) scale(${moonVisible ? 1 : 0.8})`;
                
                this.updateSkyColor(sunPos.altitude, moonPos.altitude, moonPhase);
                this.updateMoonPhaseDisplay(moonPhase);
                
                const sunTimes = SunCalc.getTimes(this.currentTime, this.latitude, this.longitude);
                const cloudCover = this.weatherData?.hourly?.cloud_cover?.[this.currentTime.getHours()] || 0;
                
                this.elements.sunPosition.textContent = `${sunPos.elevation.toFixed(1)}° (${sunPos.azimuth > 0 ? 'SW' : 'SE'})`;
                this.elements.moonPosition.textContent = `${moonPos.elevation.toFixed(1)}° (${moonPos.azimuth > 0 ? 'SW' : 'SE'})`;
                this.elements.sunriseTime.textContent = moment.tz(sunTimes.sunrise, this.timezone).format('HH:mm');
                this.elements.sunsetTime.textContent = moment.tz(sunTimes.sunset, this.timezone).format('HH:mm');
                this.elements.visibility.textContent = this.calculateVisibility(sunPos.elevation, moonPos.elevation, cloudCover);
            }

            updateDisplay() {
                this.elements.localTime.textContent = moment.tz(this.currentTime, this.timezone).format('YYYY-MM-DD HH:mm:ss');
                
                const minutes = this.currentTime.getHours() * 60 + this.currentTime.getMinutes();
                this.elements.timeSlider.value = minutes;
                this.elements.sliderTime.textContent = moment(this.currentTime).format('HH:mm');
                
                const daysDiff = Math.round((this.currentTime - new Date()) / (1000 * 60 * 60 * 24));
                this.elements.dateSlider.value = daysDiff;
                this.elements.dateDisplay.textContent = moment(this.currentTime).format('YYYY-MM-DD');
                
                this.elements.speedDisplay.textContent = this.speedMultiplier === 1 ? '1x' : 
                    this.speedMultiplier < 60 ? `${this.speedMultiplier}x` : 
                    `${Math.round(this.speedMultiplier / 60)}m`;
                
                this.updatePositions();
            }

            updateRealTimeButton() {
                if (this.isRealTime) {
                    this.elements.realTimeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    this.elements.realTimeBtn.classList.add('active');
                } else {
                    this.elements.realTimeBtn.innerHTML = '<i class="fas fa-play"></i> Real Time';
                    this.elements.realTimeBtn.classList.remove('active');
                }
            }

            startSimulation() {
                const animate = () => {
                    if (this.isRealTime) {
                        this.currentTime = new Date();
                        this.baseDate = new Date();
                    } else {
                        this.currentTime = new Date(this.currentTime.getTime() + (1000 * this.speedMultiplier));
                    }
                    
                    this.updateDisplay();
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            toggleRealTime() {
                this.isRealTime = !this.isRealTime;
                if (this.isRealTime) {
                    this.currentTime = new Date();
                    this.baseDate = new Date();
                }
                this.updateRealTimeButton();
            }

            speedUp() {
                if (this.speedMultiplier < 60) {
                    this.speedMultiplier = Math.min(this.speedMultiplier * 2, 60);
                } else {
                    this.speedMultiplier = Math.min(this.speedMultiplier + 60, 3600);
                }
                this.isRealTime = false;
                this.updateRealTimeButton();
            }

            slowDown() {
                if (this.speedMultiplier > 60) {
                    this.speedMultiplier = Math.max(this.speedMultiplier - 60, 60);
                } else {
                    this.speedMultiplier = Math.max(this.speedMultiplier / 2, 1);
                }
            }

            resetSimulation() {
                this.isRealTime = true;
                this.speedMultiplier = 1;
                this.currentTime = new Date();
                this.baseDate = new Date();
                this.updateRealTimeButton();
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            captureScreenshot() {
                html2canvas(document.body).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `celestial-simulation-${moment().format('YYYY-MM-DD-HH-mm-ss')}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(error => {
                    console.error('Screenshot failed:', error);
                    alert('Screenshot feature requires additional library. Please check console for details.');
                });
            }
        }

        let simulation;

        function toggleRealTime() {
            simulation.toggleRealTime();
        }

        function speedUp() {
            simulation.speedUp();
        }

        function slowDown() {
            simulation.slowDown();
        }

        function resetSimulation() {
            simulation.resetSimulation();
        }

        function toggleFullscreen() {
            simulation.toggleFullscreen();
        }

        function captureScreenshot() {
            simulation.captureScreenshot();
        }

        window.addEventListener('DOMContentLoaded', () => {
            simulation = new AdvancedCelestialSimulation();
        });

        window.addEventListener('beforeunload', () => {
            if (simulation && simulation.animationId) {
                cancelAnimationFrame(simulation.animationId);
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && simulation) {
                if (simulation.animationId) {
                    cancelAnimationFrame(simulation.animationId);
                }
            } else if (simulation) {
                simulation.startSimulation();
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
