<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celestial Simulation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ™</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            perspective: 2000px;
        }

        #scene {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        #sky {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: all 3s cubic-bezier(0.4, 0, 0.2, 1);
            background: radial-gradient(ellipse at center, #001122 0%, #000011 100%);
        }

        .celestial-body {
            position: absolute;
            border-radius: 50%;
            transition: all 2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        #sun {
            width: clamp(80px, 15vw, 160px);
            height: clamp(80px, 15vw, 160px);
            background: radial-gradient(circle at 30% 30%, #fff700, #ffeb3b, #ff9800, #ff5722);
            box-shadow: 
                0 0 120px rgba(255, 235, 59, 0.9),
                0 0 240px rgba(255, 152, 0, 0.7),
                0 0 360px rgba(255, 87, 34, 0.5),
                inset -25px -25px 50px rgba(255, 87, 34, 0.4);
            animation: sunPulse 4s ease-in-out infinite alternate;
            filter: brightness(1.3) saturate(1.4);
        }

        #sun::before {
            content: '';
            position: absolute;
            top: -30px;
            left: -30px;
            right: -30px;
            bottom: -30px;
            background: radial-gradient(circle, rgba(255, 235, 59, 0.4), transparent 70%);
            border-radius: 50%;
            animation: coronaRotate 20s linear infinite;
        }

        #sun::after {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            right: -50px;
            bottom: -50px;
            background: radial-gradient(circle, rgba(255, 193, 7, 0.2), transparent 60%);
            border-radius: 50%;
            animation: coronaRotate 30s linear infinite reverse;
        }

        .solar-flare {
            position: absolute;
            width: 4px;
            height: clamp(20px, 4vw, 40px);
            background: linear-gradient(to top, rgba(255, 87, 34, 0.8), transparent);
            border-radius: 2px;
            transform-origin: bottom center;
            animation: flareFlicker 2s ease-in-out infinite alternate;
        }

        .solar-flare:nth-child(1) { top: calc(-1 * clamp(20px, 4vw, 40px)); left: 50%; transform: translateX(-50%) rotate(0deg); }
        .solar-flare:nth-child(2) { top: 50%; right: calc(-1 * clamp(20px, 4vw, 40px)); transform: translateY(-50%) rotate(90deg); }
        .solar-flare:nth-child(3) { bottom: calc(-1 * clamp(20px, 4vw, 40px)); left: 50%; transform: translateX(-50%) rotate(180deg); }
        .solar-flare:nth-child(4) { top: 50%; left: calc(-1 * clamp(20px, 4vw, 40px)); transform: translateY(-50%) rotate(270deg); }

        #moon {
            width: clamp(60px, 12vw, 120px);
            height: clamp(60px, 12vw, 120px);
            background: radial-gradient(circle at 35% 25%, #f8f8f8, #e0e0e0, #bdbdbd, #9e9e9e);
            box-shadow: 
                0 0 80px rgba(248, 248, 248, 0.5),
                inset -20px -20px 40px rgba(0, 0, 0, 0.4),
                inset 15px 15px 30px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .crater {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.2));
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.7);
        }

        .crater1 { width: 15%; height: 15%; top: 20%; left: 25%; }
        .crater2 { width: 18%; height: 18%; top: 33%; right: 21%; }
        .crater3 { width: 8%; height: 8%; bottom: 25%; left: 29%; }
        .crater4 { width: 15%; height: 15%; top: 17%; right: 33%; }
        .crater5 { width: 10%; height: 10%; bottom: 33%; right: 25%; }
        .crater6 { width: 7%; height: 7%; top: 50%; left: 17%; }
        .crater7 { width: 12%; height: 12%; bottom: 17%; left: 50%; }

        .moon-terminator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.6), transparent);
            border-radius: 50%;
            transition: all 0.5s ease;
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 200px 60px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 250px 20px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 300px 90px, rgba(255,255,255,0.9), transparent),
                radial-gradient(3px 3px at 350px 50px, rgba(255,255,255,1), transparent),
                radial-gradient(1px 1px at 400px 20px, rgba(255,255,255,0.6), transparent);
            background-repeat: repeat;
            background-size: 450px 140px;
            animation: twinkle 8s ease-in-out infinite alternate;
            opacity: 0;
        }

        .constellation {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 2s ease;
        }

        .constellation-line {
            position: absolute;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            transform-origin: left center;
        }

        .milky-way {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                transparent 20%, 
                rgba(255,255,255,0.15) 30%, 
                rgba(255,255,255,0.08) 50%, 
                rgba(255,255,255,0.12) 70%, 
                transparent 80%);
            opacity: 0;
            transition: opacity 2s ease;
            animation: milkyWayShimmer 20s ease-in-out infinite alternate;
        }

        .clouds {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 40"><ellipse cx="40" cy="20" rx="25" ry="12" fill="rgba(255,255,255,0.3)"/><ellipse cx="60" cy="20" rx="30" ry="15" fill="rgba(255,255,255,0.2)"/><ellipse cx="80" cy="20" rx="20" ry="10" fill="rgba(255,255,255,0.25)"/><ellipse cx="120" cy="20" rx="35" ry="18" fill="rgba(255,255,255,0.2)"/><ellipse cx="160" cy="20" rx="25" ry="12" fill="rgba(255,255,255,0.3)"/></svg>');
            background-size: 400px 80px;
            animation: cloudDrift 45s linear infinite;
            opacity: 0.6;
        }

        .atmosphere {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center bottom, 
                rgba(135, 206, 235, 0.4) 0%, 
                rgba(135, 206, 235, 0.15) 30%, 
                transparent 60%);
            opacity: 0;
            transition: opacity 2s ease;
        }

        .aurora {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, 
                transparent 0%,
                rgba(0, 255, 127, 0.1) 20%,
                rgba(0, 191, 255, 0.1) 40%,
                rgba(138, 43, 226, 0.1) 60%,
                transparent 80%);
            opacity: 0;
            animation: auroraWave 15s ease-in-out infinite alternate;
        }

        .info-panel, .location-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.92);
            padding: clamp(12px, 2vw, 20px);
            border-radius: clamp(10px, 2vw, 15px);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            font-size: clamp(11px, 1.5vw, 13px);
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .info-panel::-webkit-scrollbar,
        .location-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-thumb,
        .location-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .info-panel {
            top: 10px;
            left: 10px;
            width: min(calc(100% - 20px), 400px);
        }

        .location-panel {
            top: 10px;
            right: 10px;
            width: min(calc(100% - 20px), 320px);
        }

        .info-header, .location-header {
            display: flex;
            align-items: center;
            margin-bottom: clamp(12px, 2vw, 20px);
            font-size: clamp(14px, 2vw, 18px);
            font-weight: 700;
        }

        .info-header {
            color: #64b5f6;
        }

        .location-header {
            color: #4caf50;
        }

        .info-header i, .location-header i {
            margin-right: 8px;
            font-size: clamp(16px, 2.2vw, 20px);
        }

        .info-section {
            margin-bottom: clamp(10px, 1.5vw, 15px);
            padding: clamp(8px, 1.5vw, 12px);
            background: rgba(255, 255, 255, 0.05);
            border-radius: clamp(8px, 1.5vw, 10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: clamp(10px, 1.3vw, 12px);
            font-weight: 600;
            color: #81c784;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item {
            margin: clamp(6px, 1vw, 8px) 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(4px, 0.8vw, 6px) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #b0bec5;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-label i {
            font-size: clamp(10px, 1.2vw, 12px);
        }

        .info-value {
            font-weight: 600;
            color: #ffffff;
            text-align: right;
        }

        .phase-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .phase-visual {
            width: clamp(20px, 3vw, 24px);
            height: clamp(20px, 3vw, 24px);
            border-radius: 50%;
            background: #424242;
            position: relative;
            overflow: hidden;
            border: 2px solid #666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .phase-light {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-radius: 50%;
            transition: all 0.5s ease;
        }

        .precision-data {
            background: rgba(33, 150, 243, 0.15);
            border-radius: clamp(6px, 1.2vw, 8px);
            padding: clamp(8px, 1.2vw, 10px);
            margin-top: clamp(8px, 1.2vw, 12px);
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .precision-item {
            display: flex;
            justify-content: space-between;
            margin: clamp(4px, 0.8vw, 5px) 0;
            font-size: clamp(10px, 1.3vw, 12px);
        }

        .precision-label {
            color: #90caf9;
            font-weight: 500;
        }

        .precision-value {
            color: #ffffff;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: clamp(10px, 1.3vw, 12px);
            color: #81c784;
            font-weight: 500;
        }

        .status-dot {
            width: clamp(6px, 1vw, 8px);
            height: clamp(6px, 1vw, 8px);
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
            flex-shrink: 0;
        }

        .horizon {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: min(300px, 30vh);
            background: linear-gradient(to top, 
                rgba(76, 175, 80, 0.4) 0%,
                rgba(76, 175, 80, 0.25) 30%,
                rgba(76, 175, 80, 0.15) 60%,
                transparent 100%);
            transition: all 2s ease;
        }

        .time-controls {
            position: absolute;
            bottom: clamp(60px, 10vh, 80px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            padding: clamp(10px, 2vw, 15px);
            border-radius: clamp(10px, 2vw, 15px);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            width: calc(100% - 20px);
            max-width: 450px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .slider-container {
            margin: clamp(8px, 1.5vw, 12px) 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: clamp(11px, 1.5vw, 13px);
            color: #b0bec5;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: clamp(16px, 2.5vw, 18px);
            height: clamp(16px, 2.5vw, 18px);
            border-radius: 50%;
            background: linear-gradient(135deg, #64b5f6, #42a5f5);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            border: 2px solid white;
        }

        input[type="range"]::-moz-range-thumb {
            width: clamp(16px, 2.5vw, 18px);
            height: clamp(16px, 2.5vw, 18px);
            border-radius: 50%;
            background: linear-gradient(135deg, #64b5f6, #42a5f5);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            border: 2px solid white;
        }

        .speed-indicator {
            text-align: center;
            margin-top: clamp(6px, 1.2vw, 10px);
            font-size: clamp(12px, 1.8vw, 14px);
            color: #64b5f6;
            font-weight: 700;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: clamp(4px, 1vw, 8px);
            flex-wrap: wrap;
            justify-content: center;
            max-width: calc(100% - 20px);
            padding: 0 10px;
        }

        .control-btn {
            padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 20px);
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: clamp(20px, 3vw, 25px);
            color: white;
            cursor: pointer;
            backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: clamp(4px, 1vw, 8px);
            font-size: clamp(11px, 1.5vw, 13px);
            white-space: nowrap;
            touch-action: manipulation;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        @media (hover: hover) {
            .control-btn:hover {
                background: rgba(255, 255, 255, 0.25);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            }
        }

        .control-btn.active {
            background: rgba(100, 181, 246, 0.4);
            border-color: #64b5f6;
            box-shadow: 0 0 15px rgba(100, 181, 246, 0.3);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: clamp(50px, 8vw, 60px);
            height: clamp(50px, 8vw, 60px);
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: clamp(14px, 2vw, 16px);
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            padding: 0 20px;
        }

        .loading-progress {
            width: min(250px, 80vw);
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #64b5f6, #42a5f5);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        @keyframes sunPulse {
            0% { 
                box-shadow: 
                    0 0 120px rgba(255, 235, 59, 0.9),
                    0 0 240px rgba(255, 152, 0, 0.7),
                    0 0 360px rgba(255, 87, 34, 0.5);
                filter: brightness(1.3) saturate(1.4);
            }
            100% { 
                box-shadow: 
                    0 0 180px rgba(255, 235, 59, 1.2),
                    0 0 300px rgba(255, 152, 0, 0.9),
                    0 0 420px rgba(255, 87, 34, 0.7);
                filter: brightness(1.5) saturate(1.6);
            }
        }

        @keyframes coronaRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes flareFlicker {
            0%, 100% { opacity: 0.7; transform: scaleY(1); }
            50% { opacity: 1; transform: scaleY(1.3); }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; }
            25% { opacity: 0.8; }
            50% { opacity: 0.5; }
            75% { opacity: 0.9; }
        }

        @keyframes milkyWayShimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        @keyframes auroraWave {
            0% { opacity: 0; transform: translateY(20px); }
            50% { opacity: 0.3; transform: translateY(0); }
            100% { opacity: 0.1; transform: translateY(-10px); }
        }

        @keyframes cloudDrift {
            from { transform: translateX(-200px); }
            to { transform: translateX(calc(100vw + 200px)); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .control-btn span.btn-text {
                display: none;
            }
            
            .info-panel, .location-panel {
                width: calc(100% - 20px);
                max-height: calc(50vh - 20px);
            }
            
            .info-panel {
                position: static;
                margin: 10px;
            }
            
            .location-panel {
                position: static;
                margin: 10px;
            }
        }

        @media (max-width: 480px) {
            .info-panel, .location-panel {
                width: calc(100% - 20px);
                padding: 10px;
            }
            
            .time-controls {
                bottom: 50px;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .info-panel, .location-panel {
                max-height: calc(100vh - 140px);
                font-size: 11px;
            }
            
            .time-controls {
                bottom: 50px;
                padding: 8px;
            }
            
            #controls {
                gap: 4px;
            }
            
            .control-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Celestial Simulation...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
    </div>

    <div id="container">
        <div id="scene">
            <div id="sky">
                <div class="stars"></div>
                <div class="constellation" id="constellation"></div>
                <div class="milky-way"></div>
                <div class="aurora"></div>
                <div class="clouds"></div>
                <div class="atmosphere"></div>
                <div class="horizon"></div>
            </div>
            
            <div id="sun" class="celestial-body">
                <div class="solar-flare"></div>
                <div class="solar-flare"></div>
                <div class="solar-flare"></div>
                <div class="solar-flare"></div>
            </div>
            
            <div id="moon" class="celestial-body">
                <div class="crater crater1"></div>
                <div class="crater crater2"></div>
                <div class="crater crater3"></div>
                <div class="crater crater4"></div>
                <div class="crater crater5"></div>
                <div class="crater crater6"></div>
                <div class="crater crater7"></div>
                <div class="moon-terminator" id="moonTerminator"></div>
            </div>
        </div>

        <div class="info-panel animate__animated animate__fadeInLeft">
            <div class="info-header">
                <i class="fas fa-satellite-dish"></i>
                Celestial Data
            </div>
            
            <div class="info-section">
                <div class="section-title">Time & Position</div>
                <div class="info-item">
                    <span class="info-label"><i class="far fa-clock"></i> Local Time:</span>
                    <span class="info-value" id="local-time">--:--:--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-globe"></i> UTC Time:</span>
                    <span class="info-value" id="utc-time">--:--:--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-calendar-day"></i> Julian Day:</span>
                    <span class="info-value" id="julian-day">--</span>
                </div>
            </div>

            <div class="info-section">
                <div class="section-title">Solar Data</div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-sun"></i> Position:</span>
                    <span class="info-value" id="sun-position">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-compass"></i> Azimuth:</span>
                    <span class="info-value" id="sun-azimuth">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-angle-up"></i> Elevation:</span>
                    <span class="info-value" id="sun-elevation">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-sunrise"></i> Sunrise:</span>
                    <span class="info-value" id="sunrise-time">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-sunset"></i> Sunset:</span>
                    <span class="info-value" id="sunset-time">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-hourglass-half"></i> Day Length:</span>
                    <span class="info-value" id="day-length">--</span>
                </div>
            </div>

            <div class="info-section">
                <div class="section-title">Lunar Data</div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-moon"></i> Position:</span>
                    <span class="info-value" id="moon-position">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-circle"></i> Phase:</span>
                    <div class="phase-indicator">
                        <div class="phase-visual">
                            <div class="phase-light" id="phase-light"></div>
                        </div>
                        <span class="info-value" id="moon-phase-name">--</span>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-percentage"></i> Illumination:</span>
                    <span class="info-value" id="moon-illumination">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-ruler"></i> Distance:</span>
                    <span class="info-value" id="moon-distance">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-arrow-up"></i> Moonrise:</span>
                    <span class="info-value" id="moonrise-time">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-arrow-down"></i> Moonset:</span>
                    <span class="info-value" id="moonset-time">--</span>
                </div>
            </div>

            <div class="precision-data">
                <div class="section-title">Precision Calculations</div>
                <div class="precision-item">
                    <span class="precision-label">Solar Declination:</span>
                    <span class="precision-value" id="solar-declination">--</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Equation of Time:</span>
                    <span class="precision-value" id="equation-time">--</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Lunar Age:</span>
                    <span class="precision-value" id="lunar-age">--</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Parallactic Angle:</span>
                    <span class="precision-value" id="parallactic-angle">--</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Atmospheric Refraction:</span>
                    <span class="precision-value" id="atmospheric-refraction">--</span>
                </div>
            </div>
        </div>

        <div class="location-panel animate__animated animate__fadeInRight">
            <div class="location-header">
                <i class="fas fa-map-marker-alt"></i>
                Location & Environment
            </div>
            <div class="location-status">
                <div class="status-dot"></div>
                <span id="location-status">Detecting...</span>
            </div>
            
            <div class="info-section">
                <div class="info-item">
                    <span class="info-label">City:</span>
                    <span class="info-value" id="location-name">Detecting...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Country:</span>
                    <span class="info-value" id="country-name">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Latitude:</span>
                    <span class="info-value" id="latitude">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Longitude:</span>
                    <span class="info-value" id="longitude">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Timezone:</span>
                    <span class="info-value" id="timezone">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Elevation:</span>
                    <span class="info-value" id="elevation">-- m</span>
                </div>
            </div>

            <div class="precision-data">
                <div class="section-title">Weather Conditions</div>
                <div class="precision-item">
                    <span class="precision-label">Temperature:</span>
                    <span class="precision-value" id="temperature">--Â°C</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Humidity:</span>
                    <span class="precision-value" id="humidity">--%</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Pressure:</span>
                    <span class="precision-value" id="pressure">-- hPa</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Cloud Cover:</span>
                    <span class="precision-value" id="cloud-cover">--%</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">Visibility:</span>
                    <span class="precision-value" id="visibility">--</span>
                </div>
                <div class="precision-item">
                    <span class="precision-label">UV Index:</span>
                    <span class="precision-value" id="uv-index">--</span>
                </div>
            </div>
        </div>

        <div class="time-controls animate__animated animate__fadeInUp">
            <div class="slider-container">
                <div class="slider-label">
                    <span><i class="far fa-clock"></i> Time Control</span>
                    <span id="slider-time">--:--</span>
                </div>
                <input type="range" id="timeSlider" min="0" max="1440" value="0" step="1">
            </div>
            <div class="slider-container">
                <div class="slider-label">
                    <span><i class="fas fa-calendar-alt"></i> Date Control</span>
                    <span id="date-display">----</span>
                </div>
                <input type="range" id="dateSlider" min="-365" max="365" value="0" step="1">
            </div>
            <div class="speed-indicator">
                Simulation Speed: <span id="speed-display">1x</span>
            </div>
        </div>

        <div id="controls" class="animate__animated animate__fadeInUp">
            <button class="control-btn" onclick="toggleRealTime()" id="realTimeBtn">
                <i class="fas fa-play"></i> <span class="btn-text">Real Time</span>
            </button>
            <button class="control-btn" onclick="speedUp()">
                <i class="fas fa-fast-forward"></i> <span class="btn-text">Speed Up</span>
            </button>
            <button class="control-btn" onclick="slowDown()">
                <i class="fas fa-backward"></i> <span class="btn-text">Slow Down</span>
            </button>
            <button class="control-btn" onclick="resetSimulation()">
                <i class="fas fa-redo"></i> <span class="btn-text">Reset</span>
            </button>
            <button class="control-btn" onclick="toggleConstellations()">
                <i class="fas fa-star"></i> <span class="btn-text">Stars</span>
            </button>
            <button class="control-btn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i> <span class="btn-text">Full</span>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script>
        class CelestialSimulation {
            constructor() {
                this.isRealTime = true;
                this.speedMultiplier = 1;
                this.currentTime = new Date();
                this.baseDate = new Date();
                
                // Default to Johannesburg, South Africa (your location)
                this.latitude = -26.2041;
                this.longitude = 28.0473;
                this.timezone = 'Africa/Johannesburg';
                this.elevation = 1753;
                this.accuracy = 0;
                
                this.animationId = null;
                this.weatherData = null;
                this.locationData = null;
                this.showConstellations = false;
                this.loadingProgress = 0;
                
                this.astronomicalConstants = {
                    EARTH_RADIUS: 6371000,
                    AU: 149597870.7,
                    LUNAR_DISTANCE: 384400,
                    SIDEREAL_DAY: 86164.0905,
                    TROPICAL_YEAR: 365.24219,
                    LUNAR_MONTH: 29.530588853
                };
                
                this.constellations = [
                    { name: 'Ursa Major', stars: [[200, 100], [250, 120], [300, 110], [350, 130], [400, 125], [450, 140], [500, 135]] },
                    { name: 'Orion', stars: [[600, 300], [650, 280], [700, 320], [620, 350], [680, 370], [720, 340], [660, 400]] },
                    { name: 'Cassiopeia', stars: [[800, 150], [850, 140], [900, 160], [950, 145], [1000, 170]] }
                ];
                
                this.elements = {
                    sun: document.getElementById('sun'),
                    moon: document.getElementById('moon'),
                    moonTerminator: document.getElementById('moonTerminator'),
                    sky: document.getElementById('sky'),
                    stars: document.querySelector('.stars'),
                    constellation: document.getElementById('constellation'),
                    milkyWay: document.querySelector('.milky-way'),
                    aurora: document.querySelector('.aurora'),
                    atmosphere: document.querySelector('.atmosphere'),
                    horizon: document.querySelector('.horizon'),
                    localTime: document.getElementById('local-time'),
                    utcTime: document.getElementById('utc-time'),
                    julianDay: document.getElementById('julian-day'),
                    sunPosition: document.getElementById('sun-position'),
                    sunAzimuth: document.getElementById('sun-azimuth'),
                    sunElevation: document.getElementById('sun-elevation'),
                    moonPosition: document.getElementById('moon-position'),
                    moonPhaseName: document.getElementById('moon-phase-name'),
                    moonIllumination: document.getElementById('moon-illumination'),
                    moonDistance: document.getElementById('moon-distance'),
                    phaseLight: document.getElementById('phase-light'),
                    sunriseTime: document.getElementById('sunrise-time'),
                    sunsetTime: document.getElementById('sunset-time'),
                    dayLength: document.getElementById('day-length'),
                    moonriseTime: document.getElementById('moonrise-time'),
                    moonsetTime: document.getElementById('moonset-time'),
                    solarDeclination: document.getElementById('solar-declination'),
                    equationTime: document.getElementById('equation-time'),
                    lunarAge: document.getElementById('lunar-age'),
                    parallacticAngle: document.getElementById('parallactic-angle'),
                    atmosphericRefraction: document.getElementById('atmospheric-refraction'),
                    visibility: document.getElementById('visibility'),
                    locationName: document.getElementById('location-name'),
                    countryName: document.getElementById('country-name'),
                    latitude: document.getElementById('latitude'),
                    longitude: document.getElementById('longitude'),
                    timezone: document.getElementById('timezone'),
                    elevation: document.getElementById('elevation'),
                    locationStatus: document.getElementById('location-status'),
                    timeSlider: document.getElementById('timeSlider'),
                    dateSlider: document.getElementById('dateSlider'),
                    sliderTime: document.getElementById('slider-time'),
                    dateDisplay: document.getElementById('date-display'),
                    speedDisplay: document.getElementById('speed-display'),
                    realTimeBtn: document.getElementById('realTimeBtn'),
                    loadingScreen: document.getElementById('loadingScreen'),
                    loadingBar: document.getElementById('loadingBar'),
                    temperature: document.getElementById('temperature'),
                    humidity: document.getElementById('humidity'),
                    cloudCover: document.getElementById('cloud-cover'),
                    pressure: document.getElementById('pressure'),
                    uvIndex: document.getElementById('uv-index')
                };

                this.init();
            }

            async init() {
                try {
                    await this.updateLoadingProgress(10, 'Acquiring GPS location...');
                    await this.getUserLocation();
                    
                    await this.updateLoadingProgress(30, 'Fetching weather data...');
                    await this.getWeatherData();
                    
                    await this.updateLoadingProgress(50, 'Calculating astronomical data...');
                    await this.calculateAstronomicalData();
                    
                    await this.updateLoadingProgress(70, 'Initializing constellations...');
                    this.initializeConstellations();
                    
                    await this.updateLoadingProgress(90, 'Setting up controls...');
                    this.setupEventListeners();
                    
                    await this.updateLoadingProgress(100, 'Simulation ready!');
                    
                    setTimeout(() => {
                        this.hideLoadingScreen();
                        this.startSimulation();
                    }, 1000);
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.setDefaultLocation();
                    this.hideLoadingScreen();
                    this.startSimulation();
                }
            }

            async updateLoadingProgress(progress, message) {
                this.loadingProgress = progress;
                this.elements.loadingBar.style.width = `${progress}%`;
                document.querySelector('.loading-text').textContent = message;
                return new Promise(resolve => setTimeout(resolve, 200));
            }

            hideLoadingScreen() {
                this.elements.loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    this.elements.loadingScreen.style.display = 'none';
                }, 500);
            }

            async getUserLocation() {
                try {
                    if (!navigator.geolocation) {
                        throw new Error('Geolocation not supported');
                    }

                    this.elements.locationStatus.textContent = 'Acquiring GPS...';
                    
                    const position = await new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => {
                            reject(new Error('Geolocation timeout'));
                        }, 10000);
                        
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                clearTimeout(timeoutId);
                                resolve(pos);
                            }, 
                            (err) => {
                                clearTimeout(timeoutId);
                                reject(err);
                            }, 
                            {
                                enableHighAccuracy: true,
                                timeout: 8000,
                                maximumAge: 300000
                            }
                        );
                    });
                    
                    this.latitude = position.coords.latitude;
                    this.longitude = position.coords.longitude;
                    this.elevation = position.coords.altitude || this.elevation;
                    this.accuracy = position.coords.accuracy || 0;
                    
                    this.elements.locationStatus.textContent = 'GPS Active';
                    
                    await this.getLocationDetails();
                    await this.getElevationData();
                    
                } catch (error) {
                    console.warn('Geolocation failed:', error.message);
                    this.elements.locationStatus.textContent = 'Using Default Location';
                    this.setDefaultLocation();
                }
            }

            setDefaultLocation() {
                this.elements.locationName.textContent = 'Johannesburg';
                this.elements.countryName.textContent = 'South Africa';
                this.elements.latitude.textContent = this.latitude.toFixed(6) + 'Â°';
                this.elements.longitude.textContent = this.longitude.toFixed(6) + 'Â°';
                this.elements.timezone.textContent = this.timezone;
                this.elements.elevation.textContent = this.elevation + ' m';
            }

            async getLocationDetails() {
                try {
                    const response = await fetch(
                        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${this.latitude}&longitude=${this.longitude}&localityLanguage=en`,
                        { signal: AbortSignal.timeout(5000) }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    this.locationData = await response.json();
                    
                    const cityName = this.locationData.city || this.locationData.locality || this.locationData.principalSubdivision || 'Unknown';
                    const countryName = this.locationData.countryName || 'Unknown';
                    
                    this.elements.locationName.textContent = cityName;
                    this.elements.countryName.textContent = countryName;
                    this.elements.latitude.textContent = this.latitude.toFixed(6) + 'Â°';
                    this.elements.longitude.textContent = this.longitude.toFixed(6) + 'Â°';
                    
                    this.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    this.elements.timezone.textContent = this.timezone;
                    
                } catch (error) {
                    console.error('Location details fetch failed:', error);
                    this.setDefaultLocation();
                }
            }

            async getElevationData() {
                try {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/elevation?latitude=${this.latitude}&longitude=${this.longitude}`,
                        { signal: AbortSignal.timeout(5000) }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.elevation && data.elevation[0] !== undefined) {
                            this.elevation = Math.round(data.elevation[0]);
                            this.elements.elevation.textContent = this.elevation + ' m';
                        }
                    }
                } catch (error) {
                    console.warn('Elevation data fetch failed:', error);
                }
            }

            async getWeatherData() {
                try {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${this.latitude}&longitude=${this.longitude}&current=temperature_2m,relative_humidity_2m,surface_pressure,cloud_cover,visibility,uv_index&timezone=auto&forecast_days=1`,
                        { signal: AbortSignal.timeout(5000) }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Weather API error: ${response.status}`);
                    }
                    
                    this.weatherData = await response.json();
                    this.updateWeatherDisplay();
                    
                } catch (error) {
                    console.error('Weather data fetch failed:', error);
                    this.setDefaultWeather();
                }
            }

            updateWeatherDisplay() {
                if (this.weatherData && this.weatherData.current) {
                    const current = this.weatherData.current;
                    
                    this.elements.temperature.textContent = `${Math.round(current.temperature_2m)}Â°C`;
                    this.elements.humidity.textContent = `${Math.round(current.relative_humidity_2m)}%`;
                    this.elements.cloudCover.textContent = `${Math.round(current.cloud_cover)}%`;
                    this.elements.pressure.textContent = `${Math.round(current.surface_pressure)} hPa`;
                    this.elements.uvIndex.textContent = `${Math.round(current.uv_index * 10) / 10}`;
                    this.elements.visibility.textContent = `${Math.round(current.visibility / 1000)} km`;
                    
                } else {
                    this.setDefaultWeather();
                }
            }

            setDefaultWeather() {
                this.elements.temperature.textContent = '--Â°C';
                this.elements.humidity.textContent = '--%';
                this.elements.cloudCover.textContent = '--%';
                this.elements.pressure.textContent = '-- hPa';
                this.elements.uvIndex.textContent = '--';
                this.elements.visibility.textContent = '-- km';
            }

            async calculateAstronomicalData() {
                const now = new Date();
                const julianDay = this.calculateJulianDay(now);
                this.elements.julianDay.textContent = julianDay.toFixed(6);
            }

            calculateJulianDay(date) {
                const a = Math.floor((14 - (date.getMonth() + 1)) / 12);
                const y = date.getFullYear() + 4800 - a;
                const m = (date.getMonth() + 1) + 12 * a - 3;
                
                return date.getDate() + Math.floor((153 * m + 2) / 5) + 365 * y + 
                       Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045 +
                       (date.getHours() - 12) / 24 + date.getMinutes() / 1440 + date.getSeconds() / 86400;
            }

            calculateSolarDeclination(date) {
                const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
                const declination = 23.45 * Math.sin((360 * (284 + dayOfYear) / 365) * Math.PI / 180);
                return declination;
            }

            calculateEquationOfTime(date) {
                const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
                const B = (360 / 365) * (dayOfYear - 81) * Math.PI / 180;
                const E = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
                return E;
            }

            calculateAtmosphericRefraction(elevation) {
                if (elevation < 0) return 0;
                const elevationRad = elevation * Math.PI / 180;
                const refraction = 1.02 / Math.tan(elevationRad + 10.3 / (elevationRad + 5.11)) / 60;
                return refraction;
            }

            calculateParallacticAngle(sunPos, moonPos) {
                const deltaAz = moonPos.azimuth - sunPos.azimuth;
                const sunAlt = sunPos.altitude * Math.PI / 180;
                const moonAlt = moonPos.altitude * Math.PI / 180;
                
                const q = Math.atan2(Math.sin(deltaAz * Math.PI / 180), 
                    Math.tan(sunAlt) * Math.cos(moonAlt) - Math.sin(moonAlt) * Math.cos(deltaAz * Math.PI / 180));
                
                return q * 180 / Math.PI;
            }

            initializeConstellations() {
                const constellationDiv = this.elements.constellation;
                constellationDiv.innerHTML = '';
                
                this.constellations.forEach(constellation => {
                    for (let i = 0; i < constellation.stars.length - 1; i++) {
                        const line = document.createElement('div');
                        line.className = 'constellation-line';
                        
                        const x1 = constellation.stars[i][0];
                        const y1 = constellation.stars[i][1];
                        const x2 = constellation.stars[i + 1][0];
                        const y2 = constellation.stars[i + 1][1];
                        
                        const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        
                        line.style.left = `${x1}px`;
                        line.style.top = `${y1}px`;
                        line.style.width = `${length}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        constellationDiv.appendChild(line);
                    }
                });
            }

            setupEventListeners() {
                this.elements.timeSlider.addEventListener('input', (e) => {
                    const minutes = parseInt(e.target.value);
                    const baseDate = new Date(this.baseDate);
                    baseDate.setHours(0, 0, 0, 0);
                    this.currentTime = new Date(baseDate.getTime() + minutes * 60000);
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                    this.updateDisplay();
                });

                this.elements.dateSlider.addEventListener('input', (e) => {
                    const days = parseInt(e.target.value);
                    this.baseDate = new Date();
                    this.baseDate.setDate(this.baseDate.getDate() + days);
                    
                    const minutes = parseInt(this.elements.timeSlider.value);
                    this.baseDate.setHours(0, 0, 0, 0);
                    this.currentTime = new Date(this.baseDate.getTime() + minutes * 60000);
                    
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                    this.updateDisplay();
                });

                window.addEventListener('resize', () => this.updatePositions());
                
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            this.toggleRealTime();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            this.speedUp();
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.slowDown();
                            break;
                        case 'r':
                            this.resetSimulation();
                            break;
                        case 'f':
                            this.toggleFullscreen();
                            break;
                        case 'c':
                            this.toggleConstellations();
                            break;
                    }
                });
            }

            calculateSunPosition(date) {
                const sunPos = SunCalc.getPosition(date, this.latitude, this.longitude);
                const azimuth = sunPos.azimuth;
                const altitude = sunPos.altitude;
                
                const refraction = this.calculateAtmosphericRefraction(altitude * 180 / Math.PI);
                const correctedAltitude = altitude + refraction * Math.PI / 180;
                
                const radius = Math.min(window.innerWidth, window.innerHeight) * 0.4;
                const x = Math.sin(azimuth) * radius * Math.cos(correctedAltitude);
                const y = -Math.sin(correctedAltitude) * radius;
                const z = Math.cos(azimuth) * radius * Math.cos(correctedAltitude);
                
                return {
                    x: window.innerWidth / 2 + x,
                    y: window.innerHeight / 2 + y,
                    z: z,
                    azimuth: azimuth * 180 / Math.PI,
                    altitude: correctedAltitude * 180 / Math.PI,
                    visible: correctedAltitude > 0
                };
            }

            calculateMoonPosition(date) {
                const moonPos = SunCalc.getMoonPosition(date, this.latitude, this.longitude);
                const azimuth = moonPos.azimuth;
                const altitude = moonPos.altitude;
                const distance = moonPos.distance;
                
                const refraction = this.calculateAtmosphericRefraction(altitude * 180 / Math.PI);
                const correctedAltitude = altitude + refraction * Math.PI / 180;
                
                const radius = Math.min(window.innerWidth, window.innerHeight) * 0.35;
                const x = Math.sin(azimuth) * radius * Math.cos(correctedAltitude);
                const y = -Math.sin(correctedAltitude) * radius;
                const z = Math.cos(azimuth) * radius * Math.cos(correctedAltitude);
                
                return {
                    x: window.innerWidth / 2 + x,
                    y: window.innerHeight / 2 + y,
                    z: z,
                    azimuth: azimuth * 180 / Math.PI,
                    altitude: correctedAltitude * 180 / Math.PI,
                    distance: distance,
                    visible: correctedAltitude > -6 * Math.PI / 180
                };
            }

            calculateMoonPhase(date) {
                const moonIllumination = SunCalc.getMoonIllumination(date);
                const phase = moonIllumination.phase;
                const fraction = moonIllumination.fraction;
                const angle = moonIllumination.angle;
                
                let phaseName;
                if (phase < 0.03 || phase > 0.97) phaseName = 'New Moon';
                else if (phase < 0.22) phaseName = 'Waxing Crescent';
                else if (phase < 0.28) phaseName = 'First Quarter';
                else if (phase < 0.47) phaseName = 'Waxing Gibbous';
                else if (phase < 0.53) phaseName = 'Full Moon';
                else if (phase < 0.72) phaseName = 'Waning Gibbous';
                else if (phase < 0.78) phaseName = 'Last Quarter';
                else phaseName = 'Waning Crescent';
                
                const lunarAge = phase * this.astronomicalConstants.LUNAR_MONTH;
                
                return {
                    phase: phase,
                    fraction: fraction,
                    angle: angle,
                    name: phaseName,
                    age: lunarAge
                };
            }

            updateMoonPhaseVisual(moonPhase) {
                const phaseLight = this.elements.phaseLight;
                const phase = moonPhase.phase;
                
                if (phase < 0.5) {
                    phaseLight.style.clipPath = `inset(0 ${(0.5 - phase) * 200}% 0 0)`;
                    phaseLight.style.borderRadius = '50%';
                } else {
                    phaseLight.style.clipPath = `inset(0 0 0 ${(phase - 0.5) * 200}%)`;
                    phaseLight.style.borderRadius = '50%';
                }
                
                const terminator = this.elements.moonTerminator;
                const terminatorPosition = (phase - 0.5) * 100;
                terminator.style.background = `linear-gradient(90deg, 
                    rgba(0, 0, 0, 0.7) ${50 + terminatorPosition}%, 
                    transparent ${50 + terminatorPosition + 10}%)`;
            }

            updateSkyColor(sunPosition, moonPosition) {
                const sunAltitude = sunPosition.altitude;
                const moonAltitude = moonPosition.altitude;
                const sky = this.elements.sky;
                
                let skyColor;
                if (sunAltitude > 6) {
                    skyColor = 'radial-gradient(ellipse at center, #87CEEB 0%, #4682B4 50%, #191970 100%)';
                } else if (sunAltitude > -6) {
                    const twilightFactor = (sunAltitude + 6) / 12;
                    const r = Math.floor(255 * twilightFactor * 0.3);
                    const g = Math.floor(100 * twilightFactor);
                    const b = Math.floor(150 * twilightFactor);
                    skyColor = `radial-gradient(ellipse at center, rgb(${r},${g},${b}) 0%, #001122 50%, #000011 100%)`;
                } else {
                    const nightBrightness = Math.max(0, moonAltitude / 90);
                    const baseBlue = Math.floor(17 + nightBrightness * 20);
                    skyColor = `radial-gradient(ellipse at center, #001122 0%, rgb(0,0,${baseBlue}) 100%)`;
                }
                
                sky.style.background = skyColor;
                
                const stars = this.elements.stars;
                const milkyWay = this.elements.milkyWay;
                const aurora = this.elements.aurora;
                const atmosphere = this.elements.atmosphere;
                
                if (sunAltitude < -12) {
                    stars.style.opacity = Math.min(1, (-sunAltitude - 12) / 30);
                    milkyWay.style.opacity = Math.min(0.6, (-sunAltitude - 18) / 40);
                    
                    if (Math.abs(this.latitude) > 60) {
                        aurora.style.opacity = Math.random() * 0.3;
                    }
                } else {
                    stars.style.opacity = 0;
                    milkyWay.style.opacity = 0;
                    aurora.style.opacity = 0;
                }
                
                if (sunAltitude > -6 && sunAltitude < 6) {
                    atmosphere.style.opacity = Math.max(0, (6 - Math.abs(sunAltitude)) / 12);
                } else {
                    atmosphere.style.opacity = 0;
                }
            }

            updatePositions() {
                const sunPos = this.calculateSunPosition(this.currentTime);
                const moonPos = this.calculateMoonPosition(this.currentTime);
                const moonPhase = this.calculateMoonPhase(this.currentTime);
                
                const sunSize = parseInt(window.getComputedStyle(this.elements.sun).width) / 2;
                const moonSize = parseInt(window.getComputedStyle(this.elements.moon).width) / 2;
                
                if (sunPos.visible) {
                    this.elements.sun.style.left = `${sunPos.x - sunSize}px`;
                    this.elements.sun.style.top = `${sunPos.y - sunSize}px`;
                    this.elements.sun.style.opacity = '1';
                    this.elements.sun.style.transform = `translateZ(${sunPos.z}px) scale(${1 + sunPos.z / 1000})`;
                } else {
                    this.elements.sun.style.opacity = '0';
                }
                
                if (moonPos.visible) {
                    this.elements.moon.style.left = `${moonPos.x - moonSize}px`;
                    this.elements.moon.style.top = `${moonPos.y - moonSize}px`;
                    this.elements.moon.style.opacity = '1';
                    this.elements.moon.style.transform = `translateZ(${moonPos.z}px) scale(${1 + moonPos.z / 1500})`;
                } else {
                    this.elements.moon.style.opacity = '0.3';
                }
                
                this.updateMoonPhaseVisual(moonPhase);
                this.updateSkyColor(sunPos, moonPos);
                this.updateCloudCover();
                
                return { sunPos, moonPos, moonPhase };
            }

            updateCloudCover() {
                const clouds = document.querySelector('.clouds');
                if (this.weatherData && this.weatherData.current) {
                    const cloudCover = this.weatherData.current.cloud_cover;
                    clouds.style.opacity = cloudCover / 100 * 0.8;
                } else {
                    clouds.style.opacity = Math.random() * 0.3;
                }
            }

            updateDisplay() {
                const { sunPos, moonPos, moonPhase } = this.updatePositions();
                
                const localTime = moment(this.currentTime).tz(this.timezone);
                const utcTime = moment(this.currentTime).utc();
                
                this.elements.localTime.textContent = localTime.format('HH:mm:ss');
                this.elements.utcTime.textContent = utcTime.format('HH:mm:ss');
                this.elements.julianDay.textContent = this.calculateJulianDay(this.currentTime).toFixed(6);
                
                this.elements.sunPosition.textContent = `${sunPos.azimuth.toFixed(1)}Â°, ${sunPos.altitude.toFixed(1)}Â°`;
                this.elements.sunAzimuth.textContent = `${sunPos.azimuth.toFixed(2)}Â°`;
                this.elements.sunElevation.textContent = `${sunPos.altitude.toFixed(2)}Â°`;
                
                this.elements.moonPosition.textContent = `${moonPos.azimuth.toFixed(1)}Â°, ${moonPos.altitude.toFixed(1)}Â°`;
                this.elements.moonPhaseName.textContent = moonPhase.name;
                this.elements.moonIllumination.textContent = `${(moonPhase.fraction * 100).toFixed(1)}%`;
                this.elements.moonDistance.textContent = `${(moonPos.distance).toFixed(0)} km`;
                
                const sunTimes = SunCalc.getTimes(this.currentTime, this.latitude, this.longitude);
                const moonTimes = SunCalc.getMoonTimes(this.currentTime, this.latitude, this.longitude);
                
                this.elements.sunriseTime.textContent = moment(sunTimes.sunrise).tz(this.timezone).format('HH:mm');
                this.elements.sunsetTime.textContent = moment(sunTimes.sunset).tz(this.timezone).format('HH:mm');
                
                const dayLength = moment(sunTimes.sunset).diff(moment(sunTimes.sunrise), 'minutes');
                const hours = Math.floor(dayLength / 60);
                const minutes = dayLength % 60;
                this.elements.dayLength.textContent = `${hours}h ${minutes}m`;
                
                if (moonTimes.rise) {
                    this.elements.moonriseTime.textContent = moment(moonTimes.rise).tz(this.timezone).format('HH:mm');
                } else {
                    this.elements.moonriseTime.textContent = 'No rise';
                }
                
                if (moonTimes.set) {
                    this.elements.moonsetTime.textContent = moment(moonTimes.set).tz(this.timezone).format('HH:mm');
                } else {
                    this.elements.moonsetTime.textContent = 'No set';
                }
                
                const solarDeclination = this.calculateSolarDeclination(this.currentTime);
                const equationOfTime = this.calculateEquationOfTime(this.currentTime);
                const atmosphericRefraction = this.calculateAtmosphericRefraction(sunPos.altitude);
                const parallacticAngle = this.calculateParallacticAngle(sunPos, moonPos);
                
                this.elements.solarDeclination.textContent = `${solarDeclination.toFixed(3)}Â°`;
                this.elements.equationTime.textContent = `${equationOfTime.toFixed(2)} min`;
                this.elements.lunarAge.textContent = `${moonPhase.age.toFixed(2)} days`;
                this.elements.parallacticAngle.textContent = `${parallacticAngle.toFixed(2)}Â°`;
                this.elements.atmosphericRefraction.textContent = `${atmosphericRefraction.toFixed(3)}Â°`;
                
                const sliderMinutes = Math.floor((this.currentTime.getHours() * 60) + this.currentTime.getMinutes());
                this.elements.timeSlider.value = sliderMinutes;
                this.elements.sliderTime.textContent = localTime.format('HH:mm');
                
                const daysDiff = Math.floor((this.currentTime - new Date()) / (1000 * 60 * 60 * 24));
                this.elements.dateSlider.value = daysDiff;
                this.elements.dateDisplay.textContent = localTime.format('YYYY-MM-DD');
                
                this.elements.speedDisplay.textContent = `${this.speedMultiplier}x`;
            }

            startSimulation() {
                const animate = () => {
                    if (this.isRealTime) {
                        this.currentTime = new Date();
                        this.baseDate = new Date();
                    } else {
                        this.currentTime = new Date(this.currentTime.getTime() + (1000 * this.speedMultiplier));
                    }
                    
                    this.updateDisplay();
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            stopSimulation() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            toggleRealTime() {
                this.isRealTime = !this.isRealTime;
                this.updateRealTimeButton();
                
                if (this.isRealTime) {
                    this.currentTime = new Date();
                    this.baseDate = new Date();
                    this.speedMultiplier = 1;
                }
            }

            updateRealTimeButton() {
                const btn = this.elements.realTimeBtn;
                if (this.isRealTime) {
                    btn.innerHTML = '<i class="fas fa-pause"></i> <span class="btn-text">Real Time</span>';
                    btn.classList.add('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-play"></i> <span class="btn-text">Simulation</span>';
                    btn.classList.remove('active');
                }
            }

            speedUp() {
                if (this.speedMultiplier < 3600) {
                    this.speedMultiplier *= 2;
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                }
            }

            slowDown() {
                if (this.speedMultiplier > 0.125) {
                    this.speedMultiplier /= 2;
                    this.isRealTime = false;
                    this.updateRealTimeButton();
                }
            }

            resetSimulation() {
                this.currentTime = new Date();
                this.baseDate = new Date();
                this.speedMultiplier = 1;
                this.isRealTime = true;
                this.updateRealTimeButton();
                this.updateDisplay();
            }

            toggleConstellations() {
                this.showConstellations = !this.showConstellations;
                const constellation = this.elements.constellation;
                constellation.style.opacity = this.showConstellations ? '1' : '0';
                
                const btn = document.querySelector('[onclick="toggleConstellations()"]');
                if (this.showConstellations) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error('Error attempting to enable fullscreen:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
        }

        let simulation;

        function toggleRealTime() {
            simulation.toggleRealTime();
        }

        function speedUp() {
            simulation.speedUp();
        }

        function slowDown() {
            simulation.slowDown();
        }

        function resetSimulation() {
            simulation.resetSimulation();
        }

        function toggleConstellations() {
            simulation.toggleConstellations();
        }

        function toggleFullscreen() {
            simulation.toggleFullscreen();
        }

        document.addEventListener('DOMContentLoaded', () => {
            simulation = new CelestialSimulation();
        });

        window.addEventListener('beforeunload', () => {
            if (simulation) {
                simulation.stopSimulation();
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (simulation) simulation.stopSimulation();
            } else {
                if (simulation) simulation.startSimulation();
            }
        });
    </script>
</body>
</html>
